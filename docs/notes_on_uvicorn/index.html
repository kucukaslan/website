<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<title>Notes on Uvicorn on Production | Muhammed Can Küçükaslan</title>
	<link rel="canonical" href="http://localhost:1313/">
	<link rel='alternate' type='application/rss+xml' title="Muhammed Can Küçükaslan RSS" href='/index.xml'>
	<link rel='stylesheet' type='text/css' href='/style.css'>
	<link rel="icon" href="/favicon.ico">
	<meta name="description" content="The uvicorn &#43; fastapi is a common default stack for Python web applications.
However, it is easy to use it incorrectly on the production environment.
A naive person could would install the fastapi and uvicorn using the pip install fastapi uvicorn (or uv add fastapi uvicorn) command.
This is not incorrect and it will work, but it leaves low hanging fruits untouched.
uvloop and httptools
However, when uvicorn is installed this way, it uses the asyncio&rsquo;s default event loop for corresponding platform, which is usually a pure python implementation.">
	<meta name="keywords" content="en, python, uvicorn, fastapi, production">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="index, follow">
	<meta charset="utf-8">
</head>
<body>
<main>
<header><h1 id="tag_Notes on Uvicorn on Production">Notes on Uvicorn on Production</h1></header>
<article>

<p>The uvicorn + fastapi is a common default stack for Python web applications.
However, it is easy to use it incorrectly on the production environment.
A naive person could would install the fastapi and uvicorn using the <code>pip install fastapi uvicorn</code> (or <code>uv add fastapi uvicorn</code>) command.
This is not incorrect and it will work, but it leaves low hanging fruits untouched.</p>
<h2 id="uvloop-and-httptools">uvloop and httptools</h2>
<p>However, when uvicorn is installed this way, it uses the <code>asyncio</code>&rsquo;s default event loop for corresponding platform, which is usually a pure python implementation.</p>
<p>Remember the rule of thumb for Python is <strong>avoid pure python implementation of anything</strong>,
not even the freaking <code>for</code> loops are exception (use numpy, pandas, etc. where possible).</p>
<p>So, we can&rsquo;t, in our right mind, use the that pure python event loop.
Luckily, there is a common suggested non-python event loop implementation: <code>uvloop</code>.
It is included in the uvicorn&rsquo;s standard dependencies, so we can just install it using the <code>uv add 'uvloop[standard]'</code> command.</p>
<p>Similarly, by default uvicorn uses some pure python http parser. Again, there is a non-python http parser implementation: <code>httptools</code> which is also included in the uvicorn[standard] dependencies.</p>
<h2 id="dont-use-gunicorn-on-kubernetes-dont-multiple-workers">Don&rsquo;t Use Gunicorn on Kubernetes, Don&rsquo;t Multiple Workers</h2>
<p>The natural next step following the protypeing the python server is to Dockerize it to be deployed in the production environment possibly on a Kubernetes cluster.</p>
<p>Now, that you&rsquo;ve seen the naive mistake in installing uvicorn, you might want to be smart before you prepare production configuration and made some research.</p>
<p>You possibly asked some famous LLMs or even found <a href="https://uvicorn.dev/deployment/">uvicorn.dev/deployment</a> and actually read the documentation by yourself like the old people.</p>
<p>Right there, in the official documentation, you see the following advice:</p>
<blockquote>
<p>Run <code>gunicorn -k uvicorn.workers.UvicornWorker</code> for production.</p></blockquote>
<p>or see</p>
<blockquote>
<p>gunicorn -w 4 -k uvicorn.workers.UvicornWorker</p></blockquote>
<p>below. Don&rsquo;t do it.
Not because it&rsquo;s wrong.
In fact this suggestion is great -but for the old-school reliable deployments to dedicated servers.</p>
<p>Gunicorn is yet another layer on top of the server.
It&rsquo;s used to manage multiple copies of the server in the same machine: distribute the load among them, restart them if they crash, etc.</p>
<p>When you deploy your application to a Kubernetes cluster, you already have a layer of load balancing and scaling. If you need multiple copies of the server, you should use multiple Kubernetes Pods. Kubernetes can manage it as well as Gunicorn can. Also, with kubernetes you get to deploy them on different nodes, and deploy other services on the same nodes.</p>
<p>If Gunicorn is used with kubernetes, then it hides some degree of flexibility and control from kubernetes. You&rsquo;d probably give higher resources to account for multiple workers. Then it may prevent kubernetes from assigning the pod to existing nodes and trigger the deployment of new nodes.</p>
<h2 id="bonus-gzip-middleware">Bonus: GZip Middleware</h2>
<p>It seems that GZip middleware (that compressses request payload/body) is not enabled by default in the uvicorn.
You need to add it manually to your application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>app<span style="color:#f92672">.</span>add_middleware(GZipMiddleware, minimum_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>, compresslevel<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span></code></pre></div><p>It may reduce the response size significantly, obviously at the cost of some CPU time.
I&rsquo;ve seen it to reduce payload size from ~900 KB to ~175 KB. TBF, it was relatively structered payload. It&rsquo;s on you to evaluate if it&rsquo;s worth it for your application.</p>
<p>JFYI, minimum_size argument is used to disable compression for smaller responses, compresslevel is the level of compression. 9 is the highest level.</p>
<h2 id="last-words">Last words</h2>
<p>It&rsquo;s obviously on you to think about the graceful shutdown, observability integrations etc.</p>
<p>I just wanted to comment on a few things that doesn&rsquo;t match with the natural assumptions.</p>


<div id="nextprev">
<a href="/faq/"><div id="prevart">Previous:<br>Frequently Asked Questions</div></a>
</div>
<div style="clear:both" class=taglist>Related<br><a id="tag_en" href="http://localhost:1313/tags/en">En</a> &middot; <a id="tag_python" href="http://localhost:1313/tags/python">Python</a> &middot; <a id="tag_uvicorn" href="http://localhost:1313/tags/uvicorn">Uvicorn</a> &middot; <a id="tag_fastapi" href="http://localhost:1313/tags/fastapi">Fastapi</a> &middot; <a id="tag_production" href="http://localhost:1313/tags/production">Production</a></div>
</article>
</main>

<footer>
	<a href="http://localhost:1313/">http://localhost:1313/</a><br><br><a href="/index.xml"><img src="/rss.svg" style="max-height:1.5em" alt="RSS Feed" title="Subscribe via RSS for updates."></a>
</footer>






<script src="/js/theme-switcher.js"></script>
</body>
</html>
